document.addEventListener("DOMContentLoaded",function(){"use strict";const e=document.getElementById("search-input"),n=document.getElementById("search-results"),s=document.getElementById("search-stats"),a=document.getElementById("search-empty"),o=document.getElementById("search-placeholder"),t=document.getElementById("clear-search");if(!e||!n)return;let i=null,r=[];fetch(`../index.json`).then(e=>{if(!e.ok)throw new Error("Failed to load search index");return e.json()}).then(e=>{if(!Array.isArray(e))throw new Error("Invalid search index format");r=e,i=new Fuse(r,{keys:[{name:"title",weight:.4},{name:"summary",weight:.3},{name:"content",weight:.2},{name:"tags",weight:.05},{name:"categories",weight:.05}],threshold:.4,includeScore:!0,includeMatches:!0,minMatchCharLength:2,ignoreLocation:!0}),console.log("Search index loaded successfully:",r.length,"posts")}).catch(e=>{console.error("Error loading search index:",e),o&&(o.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <p>搜索索引加载失败</p>
                    <small>请刷新页面重试</small>
                `)});function d(e,t){let n;return function(...s){const o=()=>{clearTimeout(n),e(...s)};clearTimeout(n),n=setTimeout(o,t)}}function l(e){if(console.log("performSearch",e),!i||!e.trim()){c();return}const t=i.search(e);u(t,e)}function u(e){if(o.style.display="none",a.style.display="none",e.length===0){s.style.display="none",n.innerHTML="",a.style.display="flex";return}s.style.display="block",s.innerHTML=`找到 <strong>${e.length}</strong> 篇相关文章`;const i=e.map(e=>{const t=e.item,o=(1-e.score)*100;let n=t.title;if(e.matches){const s=e.matches.find(e=>e.key==="title");s&&(n=h(t.title,s.indices))}let s=t.summary||t.content.substring(0,200);if(e.matches){const n=e.matches.find(e=>e.key==="content"||e.key==="summary");n&&(s=m(t.content,n.indices[0]))}return`
                <article class="search-result-item" data-score="${o.toFixed(0)}">
                    <div class="search-result-header">
                        <a href="${t.permalink}" class="search-result-title">
                            ${n}
                        </a>
                        <span class="search-result-date">${t.date}</span>
                    </div>
                    <p class="search-result-excerpt">${s}...</p>
                    <div class="search-result-meta">
                        ${t.tags?t.tags.map(e=>`<a href="/tags/${encodeURIComponent(e)}/" class="search-result-tag">${e}</a>`).join(""):""}
                    </div>
                </article>
            `}).join("");n.innerHTML=i}function h(e,t){let n="",s=0;return t.forEach(([t,o])=>{n+=e.substring(s,t),n+=`<mark class="search-highlight">${e.substring(t,o+1)}</mark>`,s=o+1}),n+=e.substring(s),n}function m(e,t){const[s]=t,o=Math.max(0,s-80),i=Math.min(e.length,s+120);let n=e.substring(o,i);return o>0&&(n="..."+n),i<e.length&&(n=n+"..."),n}function c(){o.style.display="flex",a.style.display="none",s.style.display="none",n.innerHTML=""}e.addEventListener("input",d(function(e){const n=e.target.value;t.style.display=n?"flex":"none",l(n)},300)),e.addEventListener("keydown",function(e){if(e.key==="Enter"){e.preventDefault();const t=e.target.value;l(t)}}),t.addEventListener("click",function(){e.value="",t.style.display="none",c(),e.focus()}),document.addEventListener("keydown",function(n){n.key==="Escape"&&document.activeElement===e&&(e.value="",t.style.display="none",c()),(n.ctrlKey||n.metaKey)&&n.key==="k"&&(n.preventDefault(),e.focus()),n.key==="/"&&document.activeElement!==e&&(n.preventDefault(),e.focus())})})